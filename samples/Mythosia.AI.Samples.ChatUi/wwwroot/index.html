<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mythosia.AI - Chat UI Sample</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
</head>
<body>
  <div class="app">

    <!-- ‚ïê‚ïê‚ïê LEFT: Model Selector ‚ïê‚ïê‚ïê -->
    <aside id="sidebar-left" class="sidebar sidebar-left">
      <div class="sidebar-header">
        <h2>Models</h2>
      </div>
      <div id="model-list" class="model-list"></div>

      <!-- Settings -->
      <div id="settings-area" class="settings-area hidden">
        <h3>Settings</h3>
        <div class="setting-row">
          <label>System Message</label>
          <textarea id="set-system" rows="2" placeholder="You are a helpful assistant."></textarea>
        </div>
        <div class="setting-row">
          <label>Temperature <span id="temp-val">0.7</span></label>
          <input id="set-temp" type="range" min="0" max="2" step="0.05" value="0.7" />
        </div>
        <div class="setting-row">
          <label>Top P <span id="topp-val">1.0</span></label>
          <input id="set-topp" type="range" min="0" max="1" step="0.05" value="1.0" />
        </div>
        <div class="setting-row">
          <label>Max Output Tokens</label>
          <input id="set-maxtokens" type="number" value="1024" min="1" max="200000" />
        </div>
        <div class="setting-row">
          <label>Max Messages</label>
          <input id="set-maxmsg" type="number" value="20" min="1" max="200" />
        </div>
        <div class="setting-row chk-row">
          <label><input id="set-stateless" type="checkbox" /> Stateless Mode</label>
        </div>
        <div class="setting-row chk-row">
          <label><input id="set-reasoning" type="checkbox" disabled /> Reasoning Mode</label>
        </div>
        <div id="reasoning-options" class="reasoning-options hidden">
          <label class="reasoning-options-label">Reasoning Level</label>
          <div id="reasoning-levels" class="reasoning-levels"></div>
        </div>
      </div>

      <!-- Summary Policy -->
      <div class="setting-row chk-row">
        <label><input id="set-summary" type="checkbox" /> Auto-Summarize</label>
      </div>
      <div id="summary-options" class="summary-options hidden">
        <div class="summary-trigger-row">
          <label>Trigger</label>
          <div class="rag-select summary-select">
            <button class="rag-select-trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
              <span class="rag-select-label">By Messages</span>
              <svg class="rag-select-caret" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="rag-select-menu hidden" role="listbox" aria-label="Summary trigger">
              <button class="rag-select-option" type="button" data-value="message" role="option">
                <span class="rag-select-option-label">By Messages</span>
              </button>
              <button class="rag-select-option" type="button" data-value="token" role="option">
                <span class="rag-select-option-label">By Tokens</span>
              </button>
              <button class="rag-select-option" type="button" data-value="both" role="option">
                <span class="rag-select-option-label">Both</span>
              </button>
            </div>
            <select id="summary-trigger-type" class="rag-select-native" aria-hidden="true">
              <option value="message">By Messages</option>
              <option value="token">By Tokens</option>
              <option value="both">Both</option>
            </select>
          </div>
        </div>
        <div class="summary-trigger-row">
          <label>Threshold</label>
          <input id="summary-trigger-value" type="number" value="20" min="4" max="10000" />
        </div>
        <div class="summary-trigger-row">
          <label>Keep Recent</label>
          <input id="summary-keep-value" type="number" value="5" min="1" max="100" />
        </div>
        <div id="summary-error" class="summary-error hidden"></div>
        <div id="summary-current" class="summary-current hidden">
          <div class="summary-current-header">
            <span>Current Summary</span>
            <button id="summary-clear" class="summary-clear-btn" title="Clear summary">Clear</button>
          </div>
          <div id="summary-text" class="summary-text"></div>
        </div>
      </div>

      <!-- Functions Panel -->
      <div id="functions-area" class="functions-area hidden">
        <div class="functions-header">
          <h3>Functions</h3>
          <label class="fn-toggle">
            <input id="fn-preset-toggle" type="checkbox" checked />
            <span>Preset</span>
          </label>
        </div>
        <div id="fn-list" class="fn-list">
          <p class="fn-empty">No functions registered.</p>
        </div>
      </div>

      <div class="sidebar-footer">
        <span class="brand">Mythosia.AI v4.6</span>
      </div>
    </aside>

    <!-- ‚ïê‚ïê‚ïê CENTER: Chat ‚ïê‚ïê‚ïê -->
    <main class="chat-area">
      <div class="chat-header">
        <div class="chat-status-stack">
          <span id="chat-status" class="chat-status">No model selected</span>
          <span id="rag-chat-status" class="rag-chat-status">RAG: Not indexed</span>
        </div>
        <div class="chat-actions">
          <button id="btn-doc-reference" class="btn btn-secondary btn-sm" title="Document reference">Document Reference</button>
          <button id="btn-rag-diagnose" class="btn btn-ghost btn-sm" title="RAG diagnostics" disabled>üîç Diagnose</button>
          <button id="btn-rag-settings" class="btn btn-ghost btn-sm" title="RAG pipeline settings">RAG Pipeline Settings</button>
          <button id="btn-clear" class="btn btn-ghost btn-sm" title="Clear conversation">Clear</button>
        </div>
      </div>
      <div id="chat-messages" class="chat-messages">
        <div class="empty-state">
          <div class="empty-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
          </div>
          <p>Select a model and enter your API key to start chatting.</p>
        </div>
      </div>
      <form id="chat-form" class="chat-input-area">
        <div class="chat-input-wrap">
          <textarea id="chat-input" rows="1" placeholder="Type a message..." disabled></textarea>
          <button id="btn-send" class="btn btn-primary" disabled>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </form>
    </main>

    <!-- ‚ïê‚ïê‚ïê RIGHT: Internal State ‚ïê‚ïê‚ïê -->
    <aside id="sidebar-right" class="sidebar sidebar-right">
      <div class="sidebar-header">
        <h2>Internal State</h2>
        <button id="btn-refresh-state" class="btn-icon" title="Refresh">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
        </button>
      </div>
      <div id="state-container" class="state-container">
        <div class="empty-state"><p>No service configured yet.</p></div>
      </div>
    </aside>

  </div>

  <!-- ‚ïê‚ïê‚ïê API Key Modal ‚ïê‚ïê‚ïê -->
  <div id="apikey-modal" class="modal-overlay hidden">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="modal-title">API Key</h3>
        <button id="modal-close" class="btn-icon" title="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <label class="modal-label">Enter your API key for <strong id="modal-provider-name"></strong></label>
        <div class="modal-input-wrap">
          <input id="modal-apikey-input" type="password" placeholder="sk-... or your API key" autocomplete="off" />
          <button id="modal-apikey-toggle" class="btn-icon" title="Show / Hide">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
        <div id="modal-key-status" class="modal-key-status hidden"></div>
      </div>
      <div class="modal-footer">
        <button id="modal-remove-key" class="btn btn-ghost btn-sm" style="display:none">Remove Key</button>
        <div style="flex:1"></div>
        <button id="modal-cancel" class="btn btn-secondary btn-sm">Cancel</button>
        <button id="modal-save" class="btn btn-primary btn-sm" disabled>Save Key</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Code Viewer Modal ‚ïê‚ïê‚ïê -->
  <div id="code-modal" class="modal-overlay hidden">
    <div class="modal-card code-modal-card">
      <div class="modal-header">
        <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>Library Code</h3>
        <div style="display:flex;gap:6px;align-items:center">
          <button id="code-copy-all" class="btn btn-ghost btn-sm" title="Copy code">Copy</button>
          <button id="code-modal-close" class="btn-icon" title="Close">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      </div>
      <div class="modal-body code-modal-body">
        <pre><code id="code-modal-content" class="language-csharp"></code></pre>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê RAG Diagnostics Modal ‚ïê‚ïê‚ïê -->
  <div id="rag-diag-modal" class="modal-overlay hidden">
    <div class="modal-card diag-modal-card">
      <div class="modal-header">
        <h3>üîç RAG Diagnostics</h3>
        <button id="rag-diag-modal-close" class="btn-icon" title="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="diag-tabs">
        <button class="diag-tab active" data-panel="diag-panel-health">Health Check</button>
        <button class="diag-tab" data-panel="diag-panel-why">Why Missing</button>
        <button class="diag-tab" data-panel="diag-panel-scores">Query Scores</button>
      </div>
      <div class="modal-body diag-modal-body">
        <!-- Health Check -->
        <div id="diag-panel-health" class="diag-panel active">
          <p class="diag-desc">Run a health check on the RAG index to detect chunk size issues, duplicates, and other quality problems.</p>
          <button id="diag-health-btn" class="btn btn-primary btn-sm">Run Health Check</button>
          <div id="diag-health-result" class="diag-result"></div>
        </div>
        <!-- Why Missing -->
        <div id="diag-panel-why" class="diag-panel">
          <p class="diag-desc">Analyze why a specific text was not found (or ranked low) for a given query. Traces through every pipeline stage.</p>
          <div class="diag-form">
            <label>Query (what you asked)</label>
            <input id="diag-why-query" type="text" placeholder="e.g. What is the refund policy?" />
            <label>Expected text (what should have been found)</label>
            <input id="diag-why-expected" type="text" placeholder="e.g. Full refund within 30 days" />
          </div>
          <button id="diag-why-btn" class="btn btn-primary btn-sm">Analyze</button>
          <div id="diag-why-result" class="diag-result"></div>
        </div>
        <!-- Query Scores -->
        <div id="diag-panel-scores" class="diag-panel">
          <p class="diag-desc">See ALL chunk scores for a query (not just TopK). Optionally highlight a target text.</p>
          <div class="diag-form">
            <label>Query</label>
            <input id="diag-score-query" type="text" placeholder="e.g. What is the refund policy?" />
            <label>Target text (optional)</label>
            <input id="diag-score-expected" type="text" placeholder="e.g. Full refund within 30 days" />
          </div>
          <button id="diag-score-btn" class="btn btn-primary btn-sm">Show Scores</button>
          <div id="diag-score-result" class="diag-result"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê RAG Pipeline Settings Modal ‚ïê‚ïê‚ïê -->
  <div id="rag-settings-modal" class="modal-overlay hidden">
    <div class="modal-card rag-settings-card">
      <div class="modal-header">
        <h3>RAG Pipeline Settings</h3>
        <button id="rag-settings-close" class="btn-icon" title="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body rag-settings-body">
        <div class="rag-settings-section">
          <div class="rag-settings-section-header">
            <span>Query Pipeline</span>
            <span class="rag-settings-section-hint">Used when asking questions</span>
          </div>
          <div class="rag-grid">
            <div class="rag-field">
              <label>Top K</label>
              <input id="rag-topk" type="number" value="5" min="1" max="50" />
            </div>
            <div class="rag-field">
              <label>Min score</label>
              <input id="rag-min-score" type="number" min="0" max="1" step="0.01" value="0.2" placeholder="0.0" />
              <div class="rag-hint">Score is cosine similarity (higher is better).</div>
            </div>
          </div>
          <div class="rag-field rag-field-wide">
            <label>Prompt template</label>
            <textarea id="rag-prompt-template" rows="4" placeholder="[Reference]\n{context}\n\nQuestion: {question}"></textarea>
            <div class="rag-hint">Leave empty to use the default context builder. Use {context} and {question}.</div>
          </div>
        </div>
      </div>
      <div class="modal-footer rag-settings-footer">
        <span id="rag-settings-status" class="rag-settings-status">Changes apply on the next indexing run.</span>
        <button id="rag-settings-save" class="btn btn-primary btn-sm">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê RAG Reference Modal ‚ïê‚ïê‚ïê -->
  <div id="rag-modal" class="modal-overlay hidden">
    <div class="modal-card rag-modal-card">
      <div class="modal-header">
        <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px"><path d="M4 7h16"/><path d="M4 12h10"/><path d="M4 17h16"/></svg>Document Reference</h3>
        <div class="rag-header-actions">
          <button id="rag-view-code" class="btn btn-secondary btn-sm rag-view-code-btn" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px">
              <polyline points="16 18 22 12 16 6"/>
              <polyline points="8 6 2 12 8 18"/>
            </svg>
            View Code
          </button>
          <button id="rag-modal-close" class="btn-icon" title="Close">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      </div>
      <div class="modal-body rag-modal-body">
        <div class="rag-controls">
          <div class="rag-input">
            <label>Upload documents</label>
            <input id="rag-files" type="file" multiple accept=".txt,.md,.pdf,.docx,.xlsx,.pptx" />
            <div class="rag-hint">Supports .txt, .md, .pdf, .docx, .xlsx, .pptx</div>
            <div id="rag-file-list" class="rag-file-list"></div>
          </div>
          <details class="rag-index-settings" open>
            <summary class="rag-index-settings-toggle">Indexing Settings</summary>
            <div class="rag-index-settings-body">
              <div class="rag-grid">
                <div class="rag-field">
                  <label>Chunk size</label>
                  <input id="rag-chunk-size" type="number" value="300" min="50" max="2000" />
                </div>
                <div class="rag-field">
                  <label>Chunk overlap</label>
                  <input id="rag-chunk-overlap" type="number" value="30" min="0" max="500" />
                </div>
              </div>
              <div class="rag-field rag-field-wide">
                <label>Chunking strategy</label>
                <div class="rag-select" id="rag-chunker-select">
                  <button class="rag-select-trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                    <span class="rag-select-label">Recursive (multi-separator)</span>
                    <svg class="rag-select-caret" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                  </button>
                  <div class="rag-select-menu hidden" role="listbox" aria-label="Chunking strategy">
                    <button class="rag-select-option" type="button" data-value="character" role="option">
                      <span class="rag-select-option-label">Character (separator aware)</span>
                    </button>
                    <button class="rag-select-option" type="button" data-value="token" role="option">
                      <span class="rag-select-option-label">Token (whitespace)</span>
                    </button>
                    <button class="rag-select-option" type="button" data-value="recursive" role="option">
                      <span class="rag-select-option-label">Recursive (multi-separator)</span>
                    </button>
                    <button class="rag-select-option" type="button" data-value="markdown" role="option">
                      <span class="rag-select-option-label">Markdown headings (##)</span>
                    </button>
                  </div>
                  <select id="rag-chunker" class="rag-select-native" aria-hidden="true">
                    <option value="character">Character (separator aware)</option>
                    <option value="token">Token (whitespace)</option>
                    <option value="recursive" selected>Recursive (multi-separator)</option>
                    <option value="markdown">Markdown headings (##)</option>
                  </select>
                </div>
                <div class="rag-hint">Chunk size/overlap apply to character, token, and recursive splitters.</div>
              </div>
              <div class="rag-field rag-field-wide">
                <div class="rag-field-label">
                  <label>Embedding provider</label>
                </div>
                <div id="rag-embedding-select" class="rag-select">
                  <button id="rag-embedding-trigger" class="rag-select-trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                    <span id="rag-embedding-value" class="rag-select-label">OpenAI (text-embedding-3-small)</span>
                    <span id="rag-embedding-value-badge" class="rag-badge rag-badge-inline">Recommended</span>
                    <svg class="rag-select-caret" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                  </button>
                  <div id="rag-embedding-menu" class="rag-select-menu hidden" role="listbox" aria-label="Embedding provider">
                    <button class="rag-select-option" type="button" data-value="local" role="option">
                      <span class="rag-select-option-label">Local (hashing)</span>
                    </button>
                    <button class="rag-select-option" type="button" data-value="ollama" role="option">
                      <span class="rag-select-option-label">Ollama (qwen3-embedding:4b)</span>
                    </button>
                    <button class="rag-select-option" type="button" data-value="openai" role="option">
                      <span class="rag-select-option-label">OpenAI (text-embedding-3-small)</span>
                      <span class="rag-badge">Recommended</span>
                    </button>
                  </div>
                  <select id="rag-embedding-provider" class="rag-select-native" aria-hidden="true">
                    <option value="local">Local (hashing)</option>
                    <option value="ollama">Ollama (qwen3-embedding:4b)</option>
                    <option value="openai" selected>OpenAI (text-embedding-3-small)</option>
                  </select>
                </div>
                <div id="rag-embedding-hint" class="rag-hint">OpenAI embeddings (text-embedding-3-small).</div>
              </div>
              <div class="rag-grid">
                <div class="rag-field">
                  <label>Embedding model</label>
                  <input id="rag-embedding-model" type="text" value="text-embedding-3-small" />
                </div>
                <div class="rag-field">
                  <label>Embedding dimensions</label>
                  <input id="rag-embedding-dimensions" type="number" value="1536" min="128" max="4096" />
                </div>
              </div>
              <div id="rag-embedding-base-row" class="rag-field rag-field-wide hidden">
                <label>Ollama base URL</label>
                <input id="rag-embedding-base-url" type="text" value="http://localhost:11434" />
              </div>
              <div id="rag-openai-key" class="rag-field rag-field-wide hidden">
                <label>OpenAI API key</label>
                <div class="rag-inline-input">
                  <input id="rag-openai-key-input" type="password" placeholder="sk-..." autocomplete="off" />
                  <button id="rag-openai-key-save" class="btn btn-primary btn-sm" disabled>Save</button>
                </div>
                <div id="rag-openai-key-status" class="rag-hint">Stored in localStorage for this browser.</div>
              </div>
            </div>
          </details>
          <div class="rag-actions">
            <button id="rag-run" class="btn btn-primary btn-sm" disabled>Run Reference</button>
            <span id="rag-status" class="rag-status">Awaiting files</span>
          </div>
        </div>
        <div id="rag-trace" class="rag-trace">
          <div class="rag-empty">Upload documents to see the indexing trace.</div>
        </div>
        <div class="rag-history">
          <div class="rag-history-title">Recent references</div>
          <div id="rag-history-list" class="rag-history-list">
            <div class="rag-empty">No references yet.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/csharp.min.js"></script>
  <script type="module" src="/js/custom-select.js"></script>
  <script type="module" src="/js/app.js"></script>
</body>
</html>
